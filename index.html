<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSC APPICATION</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
        }

        .table-container {
            overflow-x: auto;
        }

        .table-fixed-header thead th {
            position: sticky;
            top: 0;
            background-color: #f8fafc;
            z-index: 10;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            border-radius: 0.375rem;
        }

        .bg-success {
            background-color: #10B981;
        }

        .bg-danger {
            background-color: #EF4444;
        }

        .bg-primary {
            background-color: #3B82F6;
        }

        .bg-warning {
            background-color: #F59E0B;
            color: #1F2937;
        }

        /* --- Mobile Responsive Table Styles --- */
        @media screen and (max-width: 767px) {
            .table-container {
                overflow-x: hidden;
            }

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid #e2e8f0;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
                padding: 0.5rem;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            td {
                border: none !important;
                position: relative;
                padding-left: 50% !important;
                text-align: left !important;
                font-size: 0.875rem;
                /* sm:text-sm */
            }

            td::before {
                content: attr(data-label);
                position: absolute;
                left: 0.5rem;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: #4a5568;
            }
        }
    </style>
</head>

<div class="modal fade" id="exampleModal12" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel12">CLF -> LSC STATUS</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateToLsc">
                    <div class="row">
                        <!-- Mode -->
                        <input type="text" class="form-control rounded-3" id="Mode" name="Mode" required
                            value="UPDATE_TO_LSC" readonly style="display:none;">
                        <!-- CLF ID -->
                        <input type="text" class="form-control rounded-3" id="CLF_ID" name="CLF_ID" required readonly
                            style="display:none;">
                        <!-- sheet name -->
                        <input type="text" class="form-control rounded-3" id="CLFDetail" name="CLFDetail"
                            value="CLFDetail" required readonly style="display:none;">

                        <div class="col-md-6">  
                            <label for="CLFName" class="form-label">CLF Name <b class="text-danger">*</b></label>
                            <input type="text" class="form-control rounded-3" id="CLFName" name="CLFName" readonly
                                required>
                        </div>
                        <div class="col-md-6">
                            <label for="CLFCode" class="form-label">CLF Code <b class="text-danger">*</b></label>
                            <input type="text" class="form-control rounded-3" id="CLFCode" name="CLFCode" readonly
                                required>
                        </div>
                        <div class="col-md-6">
                            <label for="SHGCode" class="form-label">iSLSC? <b class="text-danger">*</b></label>
                            <select name="isLSC" class="form-control" id="isLSC">
                                <option value=""> -- Select Option --</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="SCOde" class="form-label">Security Code<b class="text-danger">*</b></label>
                            <input type="password" class="form-control rounded-3" id="SCOde12" name="SCOde" required>
                        </div>
                    </div>
                    <button type="submit" class="bg-green-800 text-white p-2 mt-3 btn-submit rounded-3" id="updatebtn"
                        style="float:right" ;>
                        CONFIRM </button>
                </form>
            </div>
        </div>
    </div>
</div>

<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="bg-white p-4 md:p-8 rounded-lg shadow-xl">
        <nav class="bg-gray-800 p-4">
            <div class="container mx-auto flex justify-between items-center">
                <div>
                    <a href="#" class="text-white text-lg font-semibold">MSRLS LSC APPLICATION</a>
                </div>
            </div>
        </nav>

        <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center mt-2">MSRLS CLF LIST </h1>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-6 items-end">
            <div class="col-span-full lg:col-span-2">
                <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Search...</label>
                <input type="text" id="searchInput" placeholder="Search..."
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <div>
                <label for="districtFilter" class="block text-sm font-medium text-gray-700 mb-1">District</label>
                <select id="districtFilter"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">All District</option>
                </select>
            </div>

            <div>
                <label for="blockFilter" class="block text-sm font-medium text-gray-700 mb-1">Block</label>
                <select id="blockFilter"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">Block</option>
                </select>
            </div>

            <div>
                <label for="LSCStatus" class="block text-sm font-medium text-gray-700 mb-1">Is LSC</label>
                <select id="LSCStatus"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">LSC</option>
                </select>
            </div>

            <div class="flex items-end gap-4 col-span-full md:col-span-2 lg:col-span-1 justify-between md:justify-end">
                <div>
                    <label for="showEntries" class="block text-sm font-medium text-gray-700 mb-1">Show</label>
                    <select id="showEntries"
                        class="mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button id="resetBtn"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-sm transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75">
                    Reset
                </button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
            <div class="text-sm text-gray-600">
                Last updated: <span id="lastUpdated">Fetching...</span>
            </div>
        </div>

        <center>
            <span class="text-success h1" id="msg"></span>
            <span class="text-danger h1" id="errormsg"></span>
        </center>

        <div class="table-container bg-white rounded-lg overflow-hidden shadow-md overflow-x-auto">
            <table id="meetingTable" class="min-w-full divide-y divide-gray-200 table-fixed-header">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                            SL</th>
                        <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                            District</th>
                        <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                            Block</th>
                        <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                            Village</th>
                        <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                            GP</th>
                        <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                            CLF Name</th>
                        <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                            CLF Code</th>
                        <!-- <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                            CLF Formation Date</th> -->
                        <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                            IsLSC</th>
                        <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                            Action
                        </th>
                    </tr>
                </thead>
                <tbody id="meetingTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="7" class="py-4 px-4 text-center text-gray-500">Loading data...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-center mt-6 text-sm text-gray-700">
            <div class="mb-2 md:mb-0">
                Total Entries: <span id="totalEntries">0</span>
            </div>
            <div class="flex items-center space-x-4">
                <button id="prevBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 disabled:opacity-50 disabled:cursor-not-allowed">
                    Previous
                </button>
                <span id="pageInfo">Page 1 of 1</span>
                <button id="nextBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 disabled:opacity-50 disabled:cursor-not-allowed">
                    Next
                </button>
            </div>
        </div>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        // V1 = https://script.google.com/macros/s/AKfycbwY1FP2j3qPd_JTWAOt5TWoslFVHoIUyHrzMf25Kfu9IGWuX0EmhZDHQfoRLN5Cp_nCpA/exec

        
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwHzN36yJ6pybvMIKRLktoN_28KYR_xDbWKRCRDu3ByOeeg730zeK3gEz6El-XhtMdfQw/exec";
        let allMeetingData = [];

        let dta = [];

        let filteredData = [];
        let currentPage = 1;
        let itemsPerPage = 10;

        // Get DOM elements
        const meetingTableBody = document.getElementById('meetingTableBody');
        const searchInput = document.getElementById('searchInput');

        // filter   
        const DistrictFilter = document.getElementById('districtFilter');
        const blockFilter = document.getElementById('blockFilter');
        const statusFilter = document.getElementById('LSCStatus');

        const showEntries = document.getElementById('showEntries');
        const resetBtn = document.getElementById('resetBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageInfo = document.getElementById('pageInfo');
        const totalEntriesSpan = document.getElementById('totalEntries');
        const lastUpdatedSpan = document.getElementById('lastUpdated');

        async function fetchData() {
            try {

                //const apiUrl = WEB_APP_URL;
                let nameParam = "CLFDetail"; // LSCProfile
                const apiUrl = `${WEB_APP_URL}?s=${encodeURIComponent(nameParam)}`;
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}. Response: ${errorText}`);
                }
                const rawData = await response.json();

                if (rawData.message && rawData.message.length > 1) {
                    const headers = rawData.message[0];
                    dta = rawData.message.slice(1).map(row => {
                        const rowObject = {};
                        headers.forEach((header, index) => {
                            rowObject[header] = row[index];
                        });
                        return rowObject;
                    });

                    allMeetingData = dta;
                } else {
                    dta = [];
                    allMeetingData = [];
                    console.warn("No data or headers found in the fetched response.");
                }

                initializeFilters();
                applyFiltersAndSearch();
                const now = new Date();
                lastUpdatedSpan.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            } catch (error) {
                console.error("Fetch error:", error);
                meetingTableBody.innerHTML = '<tr><td colspan="4" class="py-4 px-4 text-center text-red-500">Error loading data. Please try again.</td></tr>';
                lastUpdatedSpan.textContent = 'Failed to load';
            }
        }

        const getUniqueValues = (data, key) => [...new Set(data.map(item => item[key]).filter(Boolean))].sort();

        // Refined populateSelect function for better default text
        const populateSelect = (selectElement, values, defaultText = "Select Option") => {
            selectElement.innerHTML = `<option value="">-- ${defaultText} -- </option>`;
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                selectElement.appendChild(option);
            });
        };

        function initializeFilters() {
            const allDistrict = getUniqueValues(dta, 'District');
            populateSelect(DistrictFilter, allDistrict);
            populateSelect(blockFilter, []);
            const allstatus = getUniqueValues(dta, 'isLSC');
            populateSelect(statusFilter, allstatus);
        }

        DistrictFilter.addEventListener('change', () => {
            const selectedDistrict = DistrictFilter.value;
            const filteredByDistrict = dta.filter(item => item.District === selectedDistrict);
            const uniqueBlock = getUniqueValues(filteredByDistrict, 'Block');
            populateSelect(blockFilter, uniqueBlock);
        });

        function renderTable() {
            meetingTableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);

            if (paginatedData.length === 0) {
                const row = meetingTableBody.insertRow();
                const cell = row.insertCell();
                // FIX: Corrected colspan to 4 (matches number of <th> columns)
                cell.colSpan = 4;
                cell.textContent = "No records found.";
                cell.className = "py-4 px-4 text-center text-gray-500";
                return;
            }

            paginatedData.forEach((item, index) => {
                const row = meetingTableBody.insertRow();
                row.className = 'hover:bg-gray-50'; // Add hover effect

                const slNo = startIndex + index + 1; // Serial number
                const District = item["District"];
                const Blocks = item["Block"];
                const LSCName = item['LSC Name'];
                const CLFName = item["CLF Name"];
                const CLFCode = item["CLF Code"];
                const Village = item["Village"];
                const Gp = item["GP"];
                //let  CLFFormationdate=item["CLF_Formation_Date"];
                let IsLSC = item["isLSC"];
                let slNo123 = item['SlNo'];

                if (IsLSC == "Yes") {
                    //c10 = '<span class="badge bg-success"> Yes </span>';
                    IsLSC = '<span class="badge bg-success"> Yes </span>';
                    action = '<a target="_blank"  class="badge bg-primary" href="lscdetail.html?id=' + slNo123 + '"> View Profile </a>';
                }
                else {
                    IsLSC = '<span class="badge bg-warning"> No </span>';
                    action = `<button type="button" class="btn btn-sm btn-primary mt-1" onclick="more(${slNo123})">More..</button>`;
                }

                row.innerHTML = `
                    <td class="py-2 px-2 whitespace-nowrap text-sm font-medium text-gray-900 w-8" data-label="SL">${slNo}</td>
                    <td class="py-2 px-2 text-sm text-gray-700" data-label="Sector">${District}</td>
                    <td class="py-2 px-2 text-sm text-gray-700" data-label="Description">${Blocks} </td>
                    <td class="py-2 px-2 text-sm text-gray-700" data-label="Description"> ${Village} </td>
                    <td class="py-2 px-2 text-sm text-gray-700" data-label="Description"> ${Gp} </td>
                    <td class="py-2 px-2 text-sm text-gray-700" data-label="Description">${CLFName} </td>
                    <td class="py-2 px-2 text-sm text-gray-700" data-label="Description">${CLFCode} </td>
                    <td class="py-2 px-2 text-sm text-gray-700" data-label="Description">${IsLSC}</td>
                    <td>  ${action} 
                    </td> `;
            });

            updatePaginationInfo();
        }

        function applyFiltersAndSearch() {
            let data = [...allMeetingData];
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedblock = blockFilter.value;
            const selectedStatus = statusFilter.value;
            if (searchTerm) {
                data = data.filter(item =>
                    Object.values(item).some(value =>
                        String(value).toLowerCase().includes(searchTerm)
                    )
                );
            }

            if (selectedblock) {
                data = data.filter(item => item["Block"] === selectedblock);
            }

            if (selectedStatus) {
                data = data.filter(item => item["isLSC"] === selectedStatus);
            }

            filteredData = data;
            currentPage = 1;
            renderTable();
        }

        // to load in modal 
        function more(id) {
            const rowData = filteredData.find(item => item["SlNo"] === id);
           
            if (rowData) {
                $('#exampleModal12').modal('show');
                // $("#ApproveSheet").val($("#BlockforLoaddta").val())
                document.getElementById('CLF_ID').value = rowData["SlNo"];
                document.getElementById('CLFName').value = rowData["CLF Name"];
                document.getElementById('CLFCode').value = rowData["CLF Code"];
            } else {
                console.log("No data found for the given UID.");
            }
        }

        // function to --- Update CLF - LSC --- 
        const updateToLsc = document.getElementById('updateToLsc');
        updateToLsc.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent the default form submission
            const formData = new FormData(updateToLsc);
            try {
                $("#updatebtn").attr("disabled", true);
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}. Response: ${errorText}`);
                }
                const result = await response.json();
                if (result.success) {
                    updateToLsc.reset();
                    $('#exampleModal12').modal('hide');
                    $('#msg').text("Sucessfully updated");
                    alert("Sucessfully Updated");
                    location.reload();
                } else {
                    $('#UPDATEModal').modal('hide');
                    $('#msg').css('color', 'red');  //with ID
                    $('#msg').text("Failed to Update Data.");
                    alert("Failed to update the Data");
                   
                }
            } catch (error) {
                alert("Some error occur.");
                $('#exampleModal12').modal('hide');
                $('#errormsg').text("Failed to Update Data.");
            }
        });




        function updatePaginationInfo() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
            totalEntriesSpan.textContent = filteredData.length;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        searchInput.addEventListener('keyup', applyFiltersAndSearch);
        blockFilter.addEventListener('change', applyFiltersAndSearch);
        statusFilter.addEventListener('change', applyFiltersAndSearch);

        //villageFilter.addEventListener('change', applyFiltersAndSearch);

        showEntries.addEventListener('change', (event) => {
            itemsPerPage = parseInt(event.target.value, 10);
            applyFiltersAndSearch();
        });

        // Reset button
        resetBtn.addEventListener('click', () => {
            searchInput.value = '';
            DistrictFilter.value = '';
            blockFilter.value = '';
            statusFilter.value = '';
            showEntries.value = '10';
            itemsPerPage = 10;
            applyFiltersAndSearch();
        });

        // Pagination buttons
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        nextBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</body>

</html>
